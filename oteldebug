#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = [
#     "opentelemetry-api>=1.20.0",
#     "opentelemetry-sdk>=1.20.0",
#     "opentelemetry-exporter-otlp-proto-http>=1.20.0",
#     "opentelemetry-exporter-otlp-proto-grpc>=1.20.0",
#     "click>=8.0.0"
# ]
# ///

from __future__ import annotations

import logging
import time
import urllib.error
import urllib.request
from typing import Iterable

import click
from opentelemetry import trace
from opentelemetry._logs import set_logger_provider
from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import (
    OTLPSpanExporter as OTLPSpanExporterGrpc,
)
from opentelemetry.exporter.otlp.proto.http._log_exporter import OTLPLogExporter
from opentelemetry.exporter.otlp.proto.http.trace_exporter import (
    OTLPSpanExporter as OTLPSpanExporterHttp,
)
from opentelemetry.sdk._logs import LoggerProvider, LoggingHandler
from opentelemetry.sdk._logs.export import (
    BatchLogRecordProcessor,
    ConsoleLogExporter,
)
from opentelemetry.sdk.resources import SERVICE_NAME, Resource
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor, ConsoleSpanExporter


@click.group()
def cli() -> None:
    """OpenTelemetry testing utilities for debugging OTLP collectors."""


@cli.command("test-span")
@click.option(
    "--host",
    default="localhost",
    show_default=True,
    help="OTLP endpoint host (default: localhost).",
)
@click.option(
    "--protocol",
    default="http",
    type=click.Choice(["http", "grpc"]),
    show_default=True,
    help="Protocol to use (http posts to an HTTP OTLP endpoint, grpc uses OTLP gRPC).",
)
@click.option(
    "--port",
    default=4318,
    show_default=True,
    help="OTLP port (HTTP typically 4318, gRPC typically 4317).",
)
@click.option(
    "--route",
    default="v1/traces",
    show_default=True,
    help="HTTP route for spans (ignored for gRPC). Example: v1/traces.",
)
@click.option(
    "--span-name",
    default="test-span",
    show_default=True,
    help="Name of the test span.",
)
@click.option(
    "--service-name",
    default="curl-test-service",
    show_default=True,
    help="Service name/resource attribute for the span.",
)
@click.option(
    "--console",
    is_flag=True,
    help="Also export to console for debugging (no network).",
)
@click.option(
    "--attributes",
    multiple=True,
    help="Custom attributes: key=value (can be repeated).",
)
def test_span(
    host: str,
    protocol: str,
    port: int,
    route: str,
    span_name: str,
    service_name: str,
    console: bool,
    attributes: Iterable[str],
) -> None:
    """Send a test span to the OTLP collector/endpoint."""
    if protocol == "http":
        endpoint = f"http://{host}:{port}/{route.lstrip('/')}"
    else:
        # gRPC exporter expects host:port without scheme.
        endpoint = f"{host}:{port}"

    click.echo(f"Sending test span to: {endpoint}")
    click.echo(f"Service: {service_name}")
    click.echo(f"Span: {span_name}")
    click.echo(f"Protocol: {protocol}")

    resource = Resource.create({SERVICE_NAME: service_name})
    tracer_provider = TracerProvider(resource=resource)

    if console:
        tracer_provider.add_span_processor(BatchSpanProcessor(ConsoleSpanExporter()))
        click.echo("Console export enabled")

    # Choose exporter based on protocol
    if protocol == "http":
        otlp_exporter = OTLPSpanExporterHttp(endpoint=endpoint)
    else:
        # Using insecure gRPC by default (common for local dev); TLS requires additional params.
        otlp_exporter = OTLPSpanExporterGrpc(endpoint=endpoint, insecure=True)

    tracer_provider.add_span_processor(BatchSpanProcessor(otlp_exporter))
    trace.set_tracer_provider(tracer_provider)
    tracer = trace.get_tracer(__name__)

    try:
        with tracer.start_as_current_span(span_name) as span:
            span.set_attribute("test.timestamp", str(time.time()))
            span.set_attribute("test.host", host)
            span.set_attribute("test.port", port)
            span.set_attribute("test.protocol", protocol)
            if protocol == "http":
                span.set_attribute("test.http_route", route)

            for attr in attributes:
                if "=" in attr:
                    key, value = attr.split("=", 1)
                    span.set_attribute(key, value)

            span.add_event("Test span created")
            click.echo("Test span created successfully")
            time.sleep(0.1)  # give the batch processor a moment

        tracer_provider.force_flush(timeout_millis=5000)
        click.echo("Span sent to OTLP endpoint")
    except Exception as e:  # noqa: BLE001
        click.echo(f"Error sending span: {e}", err=True)
        raise SystemExit(1)


@cli.command("test-logs")
@click.option(
    "--host",
    default="localhost",
    show_default=True,
    help="OTLP endpoint host (default: localhost).",
)
@click.option(
    "--protocol",
    default="http",
    type=click.Choice(["http", "grpc"]),
    show_default=True,
    help="Protocol to use (logs exporter here uses HTTP).",
)
@click.option(
    "--port",
    default=4318,
    show_default=True,
    help="OTLP port for logs HTTP (typically 4318).",
)
@click.option(
    "--route",
    default="v1/logs",
    show_default=True,
    help="HTTP route for logs. Examples: v1/logs (Tempo/collectors), otlp/v1/logs (Loki 3.x).",
)
@click.option(
    "--service-name",
    default="curl-test-service",
    show_default=True,
    help="Service name/resource attribute for logs.",
)
@click.option(
    "--message",
    default="Test log message",
    show_default=True,
    help="Log message to send.",
)
@click.option(
    "--level",
    default="INFO",
    type=click.Choice(["DEBUG", "INFO", "WARN", "ERROR"]),
    show_default=True,
    help="Log level to emit.",
)
@click.option(
    "--console",
    is_flag=True,
    help="Also export logs to console for debugging (no network).",
)
def test_logs(
    host: str,
    protocol: str,
    port: int,
    route: str,
    service_name: str,
    message: str,
    level: str,
    console: bool,
) -> None:
    """Send test logs to the OTLP collector."""
    # Only HTTP OTLP logs exporter is used below.
    endpoint = f"http://{host}:{port}/{route.lstrip('/')}"
    click.echo(f"Sending test log to: {endpoint}")
    click.echo(f"Service: {service_name}")
    click.echo(f"Message: {message}")
    click.echo(f"Level: {level}")

    try:
        resource = Resource.create({SERVICE_NAME: service_name})
        log_provider = LoggerProvider(resource=resource)

        if console:
            log_provider.add_log_record_processor(
                BatchLogRecordProcessor(ConsoleLogExporter())
            )
            click.echo("Console log export enabled")

        otlp_log_exporter = OTLPLogExporter(endpoint=endpoint)
        log_provider.add_log_record_processor(
            BatchLogRecordProcessor(otlp_log_exporter)
        )
        set_logger_provider(log_provider)

        handler = LoggingHandler(logger_provider=log_provider)
        logger = logging.getLogger("test-logger")
        logger.addHandler(handler)
        logger.setLevel(getattr(logging, level))

        getattr(logger, level.lower())(message)

        log_provider.force_flush(timeout_millis=5000)
        click.echo("Log sent to OTLP endpoint")
    except Exception as e:  # noqa: BLE001
        click.echo(f"Error sending log: {e}", err=True)
        raise SystemExit(1)


@cli.command("test-connectivity")
@click.option(
    "--host",
    default="localhost",
    show_default=True,
    help="Host to probe (default: localhost).",
)
@click.option(
    "--port",
    default=4318,
    show_default=True,
    help="Port to probe (default: 4318).",
)
def test_connectivity(host: str, port: int) -> None:
    """Test basic connectivity to common OTLP HTTP endpoints."""
    endpoints = [
        f"http://{host}:{port}/",
        f"http://{host}:{port}/v1/traces",
        f"http://{host}:{port}/v1/logs",
        f"http://{host}:{port}/v1/metrics",
    ]

    for endpoint in endpoints:
        try:
            req = urllib.request.Request(endpoint)
            resp = urllib.request.urlopen(req, timeout=5)
            click.echo(f"✅ {endpoint} - Status: {resp.getcode()}")
        except urllib.error.HTTPError as e:
            if e.code == 405:
                click.echo(f"✅ {endpoint} - Reachable (405 Method Not Allowed - expected)")
            else:
                click.echo(f"⚠️  {endpoint} - HTTP Error: {e.code}")
        except urllib.error.URLError as e:
            click.echo(f"❌ {endpoint} - Connection Error: {e}")
        except Exception as e:  # noqa: BLE001
            click.echo(f"❌ {endpoint} - Error: {e}")


if __name__ == "__main__":
    cli()
