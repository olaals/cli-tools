#!/usr/bin/env python3
from pathlib import Path
import cv2
import typer

app = typer.Typer()

@app.command()
def main(
    video: Path = typer.Argument(..., help="Path to the video file (supports mp4)"),
    images_per_sec: int = typer.Option(1, help="Number of images to extract per second"),
    image_dir: Path = typer.Option(Path("images"), help="Directory to save extracted images")
) -> None:
    # Create the output directory if it doesn't exist
    image_dir.mkdir(parents=True, exist_ok=True)
    
    # Open the video file
    cap = cv2.VideoCapture(str(video))
    if not cap.isOpened():
        typer.echo(f"Error: Cannot open video file {video}")
        raise typer.Exit(code=1)
    
    fps = cap.get(cv2.CAP_PROP_FPS)
    if fps == 0:
        typer.echo("Error: Cannot determine FPS of the video")
        raise typer.Exit(code=1)
    
    frame_interval = max(int(round(fps / images_per_sec)), 1)
    
    count = 0
    saved = 0
    while True:
        ret, frame = cap.read()
        if not ret:
            break
        if count % frame_interval == 0:
            output_path = image_dir / f"frame_{saved:05d}.jpg"
            cv2.imwrite(str(output_path), frame)
            saved += 1
        count += 1
    
    cap.release()
    typer.echo(f"Extracted {saved} images to '{image_dir}'.")

if __name__ == "__main__":
    app()
